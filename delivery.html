<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Bouquet - 전달하기</title>
    <script>
    // Adobe Typekit 로더 (기존 유지)
    (function(d) {
      var config = {
        kitId: 'bno4gef',
        scriptTimeout: 3000,
        async: true
      },
      h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
    })(document);
    </script>
    <link rel="stylesheet" href="https://use.typekit.net/bno4gef.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- 기본 및 비디오 스타일 --- */
        body {
            background-color: #000;
            color: white;
            height: 100vh;
            margin: 0;
            font-family: "pretendard", sans-serif;
            overflow: hidden;
            position: relative;
        }

        #video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }

        /* --- UI 및 중앙 정렬 --- */
        #delivery-ui-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            z-index: 10;
        }
        
        /* --- 꽃다발 드래그 가능 요소 (초기 위치 수정) --- */
        #draggable-bouquet {
            position: absolute;
            width: 40vw;
            height: auto;
            max-height: 80vh;
            /* 초기 상태: 드래그 비활성화, 포인터 커서 */
            cursor: pointer;
            user-select: none;
            /* [수정] 완전 하단으로 배치 */
            left: 52%; /* 중앙 정렬 */
            bottom: -20vh; /* 완전 하단 */
            transform: translateX(-50%); /* 중앙 정렬 보정 */
            z-index: 20;
            transition: opacity 1.5s ease-out; 
        }

        /* 전달 모드에서만 드래그 커서로 변경 */
        #draggable-bouquet.delivery-mode {
            cursor: grab;
        }
        
        /* --- 파동 애니메이션 (Grab/Click Signal) --- */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
            70% { box-shadow: 0 0 0 60px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }

        .pulse-target {
            border-radius: 50%;
            transition: all 0.3s;
            pointer-events: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            background-color: rgba(255, 255, 255, 0.8);
            animation: pulse 2s infinite;
            z-index: 99;
        }
        
        /* 초기 신호 위치: 꽃다발과 동일하게 완전 하단 */
        #initial-signal {
            bottom: 5vh; /* 꽃다발이 있는 영역에 배치 */
            top: auto !important; /* JS의 top 설정을 무시 */
        }

        /* 전달 목표 지점 파동 위치 조정 */
        #target-signal {
             bottom: 60% !important; /* 전달 목표 지점 (화면 중앙 상단 근처) */
             top: auto !important;
        }

        /* --- 안내 메시지 박스 --- */
        #guide-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 2vw 4vw;
            background-color: rgba(0, 0, 0, 0.7);
            color: #cdff45;
            font-size: 1.5vw;
            text-align: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.5s ease-in-out ;
            pointer-events: none;
        }

        #guide-message.show {
            opacity: 1;
        }
        
        /* --- 전달 완료 화면 --- */
        #completion-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        #completion-box {
            padding: 4vw 6vw;
            background-color: rgba(0, 0, 0, 0.9); 
            border: 1px solid #cdff45;
            color: #cdff45;
            text-align: center;
            font-family: "argent-pixel-cf", sans-serif;
            font-size: 3vw;
            box-shadow: 0 0 30px rgba(205, 255, 69, 0.5);
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }

        #go-main-button {
            padding: 1vw 5vw;
            font-size: 2vw;
            font-family: "argent-pixel-cf", sans-serif;
            font-weight: 900;
            font-style: regular;
            color: #cdff45;
            background: rgba(0, 0, 0, 0.434);
            border: #cdff45 1px solid ;
            cursor: pointer;
            transition: background 0.3s, color 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-top: 4vw;;
        }
        #go-main-button:hover {
            background: #cdff45;
            color: rgb(0, 0, 0);
        }
        
    </style>
    
</head>
<body>
    <video id="video-background" preload="auto" poster="walk_poster.jpg" playsinline muted>
        <source src="walk.mp4" type="video/mp4"> 
        Your browser does not support the video tag.
    </video>
    
    <div id="delivery-ui-wrapper">
        <img id="draggable-bouquet" src="" alt="드래그 가능한 꽃다발">
        
        <div id="initial-signal" class="pulse-target"></div>
        
        <div id="target-signal" class="pulse-target" style="opacity: 0; display: none;"></div>
        
    </div>

    <div id="guide-message"></div>
    
    <div id="completion-overlay">
        <div id="completion-box">
            BOUQUET IS DELIVERED!
            <button id="go-main-button">GO MAIN</button>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const video = document.getElementById('video-background');
        const bouquetImg = document.getElementById('draggable-bouquet');
        const initialSignal = document.getElementById('initial-signal');
        const targetSignal = document.getElementById('target-signal');
        const guideMessage = document.getElementById('guide-message');
        const completionOverlay = document.getElementById('completion-overlay');
        const goMainButton = document.getElementById('go-main-button');
        
        let isDragging = false;
        let videoPlaying = false; // 비디오 재생 중 여부 (걷는 중)
        let videoEnded = false; // 영상 종료 여부 (전달 모드)
        let initialGuideCompleted = false; // 초기 안내 완료 여부
        
        // 🌟 Blob URL 변수 선언 및 데이터 로드 🌟
        const finalBouquetBlobURL = sessionStorage.getItem('finalBouquetImageURL');
        
        if (!finalBouquetBlobURL) {
            alert("꽃다발 이미지 데이터가 없습니다. 다시 시작해주세요.");
            window.location.href = "love.html"; // 적절한 시작 페이지로 변경
            return;
        }

        bouquetImg.src = finalBouquetBlobURL; 
        
        // ------------------------------------------------------------------
        // [1. 메모리 해제 로직 추가]
        // ------------------------------------------------------------------
        const cleanupBlobURL = () => {
             if (finalBouquetBlobURL) {
                 URL.revokeObjectURL(finalBouquetBlobURL);
                 sessionStorage.removeItem('finalBouquetImageURL');
                 console.log("꽃다발 Blob URL 해제됨.");
             }
             const letterBlobURL = sessionStorage.getItem('capturedLetterImageURL');
             if (letterBlobURL) {
                 URL.revokeObjectURL(letterBlobURL);
                 sessionStorage.removeItem('capturedLetterImageURL');
                 console.log("편지지 Blob URL 해제됨.");
             }
        };

        window.addEventListener('unload', cleanupBlobURL);
        
        // [2. 초기 설정]
        video.load(); // 첫 프레임을 로드
        initialSignal.style.display = 'none';

        // [3. 안내 메시지 표시 함수]
        const showGuide = (message, duration, callback) => {
            guideMessage.textContent = message;
            guideMessage.classList.add('show');
            setTimeout(() => {
                guideMessage.classList.remove('show');
                if (callback) {
                    setTimeout(callback, 500); 
                }
            }, duration);
        };

        // [4. 비디오 재생 시작 함수 - 클릭/터치 시 호출]
        const startVideo = () => {
            if (!initialGuideCompleted || videoPlaying || videoEnded) return;

            videoPlaying = true;
            video.play();
            initialSignal.style.display = 'none'; // 클릭 후 초기 신호 제거
            bouquetImg.style.cursor = 'default'; // 걷는 중 드래그 방지
            
            // 비디오 재생 중에는 드래그 이벤트를 막기 위해 임시로 해제하거나, 드래그 로직 내에서 분기 처리
            // 현재는 startDrag/doDrag 내에서 videoEnded와 videoPlaying 상태를 확인하여 드래그를 막음
        };
        
        // [5. 비디오 끝 이벤트]
        video.onended = () => {
            videoPlaying = false;
            videoEnded = true;
            // 비디오 끝 프레임 유지
            video.pause(); 
            video.currentTime = video.duration; 
            
            showGuide("상대방 앞에 도착했어요. 꽃다발을 상대에게 전달해주세요! 💐", 3000, () => {
                // 전달 모드 시작: 꽃다발을 끌어서 중앙 목표 지점에 놓도록 안내
                targetSignal.style.display = 'block';
                targetSignal.style.opacity = 1;
                bouquetImg.classList.add('delivery-mode'); // 드래그 커서 활성화
            });
        };
        
        // [6. 드래그 로직]
        let offsetX, offsetY;

        const startDrag = (e) => {
            if (!videoEnded) return; // 비디오가 끝나지 않았으면 드래그 불가능
            if (isDragging) return; 
            
            isDragging = true;
            bouquetImg.style.cursor = 'grabbing';
            targetSignal.style.opacity = 0; // 드래그 시작 시 목표 신호 페이드 아웃
            
            const rect = bouquetImg.getBoundingClientRect();
            
            // 터치 이벤트 대응
            const clientX = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;
            
            offsetX = clientX - rect.left;
            offsetY = clientY - rect.top;

            // 드래그 시작 시점의 위치를 절대값(fixed)으로 고정
            bouquetImg.style.position = 'fixed';
            bouquetImg.style.left = `${clientX - offsetX}px`;
            bouquetImg.style.top = `${clientY - offsetY}px`;
            bouquetImg.style.bottom = 'auto'; // bottom 해제
            bouquetImg.style.transform = 'none';
        };

        const doDrag = (e) => {
            if (!isDragging || !videoEnded) return; // 드래그 모드가 아니거나 비디오가 끝나지 않았으면 무시

            e.preventDefault(); // 스크롤 방지 (터치 환경)

            const clientX = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;

            let newX = clientX - offsetX;
            let newY = clientY - offsetY;
            
            bouquetImg.style.left = `${newX}px`;
            bouquetImg.style.top = `${newY}px`;
            
            // 전달 모드: 중앙 전달 지점 도달 확인
            const targetCenterX = window.innerWidth / 2;
            // target-signal의 CSS bottom: 60%에 맞춰 y축 목표 지점 설정 (top: 40%와 유사)
            const targetCenterY = window.innerHeight * (1 - 0.6); 
            
            const bouquetCenterX = newX + (bouquetImg.offsetWidth / 2);
            const bouquetCenterY = newY + (bouquetImg.offsetHeight / 2);
            
            const distance = Math.sqrt(
                Math.pow(bouquetCenterX - targetCenterX, 2) + 
                Math.pow(bouquetCenterY - targetCenterY, 2)
            );

            // 중앙 지점(약 100px 반경)에 도달하면 완료
            if (distance < 100) {
                finishDeliverySequence();
            }
        };
        
        const stopDrag = () => {
            if (!isDragging || !videoEnded) return; // 비디오가 끝나지 않았으면 드래그를 멈춰도 아무 일도 없음
            
            isDragging = false;
            bouquetImg.style.cursor = 'grab'; // 전달 모드 유지
            
            // 드래그를 놓았을 때 원래 위치로 돌아가도록 강제하지 않음 (전달 의도 유지)
            
            // 목표 신호가 사라진 상태라면 다시 표시
            if (targetSignal.style.opacity == 0) {
                targetSignal.style.opacity = 1;
            }
        };
        
        // [7. 최종 전달 완료 시퀀스]
        const finishDeliverySequence = () => {
            // 모든 이벤트 리스너 제거 (중요)
            document.removeEventListener('mousemove', doDrag);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchmove', doDrag);
            document.removeEventListener('touchend', stopDrag);
            bouquetImg.removeEventListener('mousedown', startDrag);
            bouquetImg.removeEventListener('touchstart', startDrag);
            
            isDragging = false;
            
            // 1. 페이드 아웃 시작
            bouquetImg.style.opacity = 0; 
            targetSignal.style.display = 'none';
            guideMessage.classList.remove('show');
            
            // 2. 1.5초 후 완료 오버레이 표시
            setTimeout(() => {
                completionOverlay.style.display = 'flex';
                // 🌟 전달이 완료된 후에 Blob URL 해제 🌟
                cleanupBlobURL(); 
            }, 1500); 
        };

        // [8. 이벤트 리스너 연결 및 분리]
        
        // 걷기 시작 (클릭/터치) 이벤트 (비디오 재생)
        // NOTE: body에 이벤트를 걸면 비디오가 아닌 요소를 클릭해도 재생되므로, 꽃다발 이미지에만 걸어줍니다.
        const videoStartListener = (e) => {
            if (initialGuideCompleted && !videoPlaying && !videoEnded) {
                startVideo();
                // 비디오 재생이 시작되면 이 리스너는 제거
                bouquetImg.removeEventListener('click', videoStartListener);
                bouquetImg.removeEventListener('touchstart', videoStartListener);
            }
        };
        bouquetImg.addEventListener('click', videoStartListener);
        bouquetImg.addEventListener('touchstart', videoStartListener, { passive: true });

        // 전달 모드 드래그 이벤트 (비디오 끝난 후)
        bouquetImg.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', doDrag);
        document.addEventListener('mouseup', stopDrag);
        
        // 모바일 터치 이벤트
        bouquetImg.addEventListener('touchstart', startDrag, { passive: false });
        document.addEventListener('touchmove', doDrag, { passive: false });
        document.addEventListener('touchend', stopDrag);


        // 버튼 이벤트
        goMainButton.addEventListener('click', () => {
            window.location.href = "index.html";
        });

        
        // [9. 초기 안내 메시지]
        setTimeout(() => {
            // 안내 메시지 수정: "잡고 걸으세요" -> "잡고 클릭/터치하여 걸으세요" 또는 "터치하여 걸으세요"
            showGuide("저 앞에 상대방이 기다리고 있어요. 꽃다발을 **클릭 또는 터치하여** 걸어가세요.", 4000, () => {
                initialGuideCompleted = true; // 초기 안내 완료
                initialSignal.style.display = 'block'; // 초기 클릭/터치 신호 표시
            });
        }, 1000);
    });
</script>
</body>
</html>
